<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Регистрация - FormMaker')}"></head>
<body>
<header class="container">
    <h1>Регистрация</h1>
    <p class="muted">Создайте учетную запись</p>
    <th:block th:replace="~{fragments/navbar :: navbar}"></th:block>
    <div class="card">
        <!--        <form method="post" th:action="@{/registration}" th:object="${user}">-->
        <!--            <label for="email">Email</label>-->
        <!--            <input id="email" type="email" th:field="*{email}" required>-->

        <!--            <label for="username">Логин</label>-->
        <!--            <input id="username" type="text" th:field="*{username}" required>-->

        <!--            <label for="password">Пароль</label>-->
        <!--            <input id="password" type="password" th:field="*{password}" required>-->

        <!--            <div class="actions">-->
        <!--                <button class="btn" type="submit">Создать</button>-->
        <!--                <a class="btn secondary" th:href="@{/login}">У меня уже есть аккаунт</a>-->
        <!--            </div>-->
        <!--        </form>-->
        <form id="registerForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <label for="email">Email</label>
            <input id="email" type="email" name="email" required>

            <label for="username">Логин</label>
            <input id="username" type="text" name="username" required>

            <label for="password">Пароль</label>
            <input id="password" type="password" name="password" required>

            <div class="actions">
                <button class="btn" type="submit">Создать</button>
                <a class="btn secondary" th:href="@{/login}">У меня уже есть аккаунт</a>
            </div>
            <p class="muted" id="errorMessage" style="display:none;"></p>
        </form>
    </div>
    <!-- CSRF meta for JS fetch (на случай SPA-запросов) -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</header>
<script>
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const token = document.querySelector('meta[name="_csrf"]').content;
        const headerName = document.querySelector('meta[name="_csrf_header"]').content;
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', [headerName]: token },
            body: JSON.stringify({email, username, password})
        });

        const errorMessage = document.getElementById('errorMessage');

        if (response.ok) {
            const data = await response.json();
            localStorage.setItem('accessToken', data.accessToken);
            localStorage.setItem('refreshToken', data.refreshToken);
            window.location.href = '/'; // редирект на главную
        } else {
            const error = await response.text();
            errorMessage.textContent = error || 'Ошибка регистрации';
            errorMessage.style.display = 'block';
        }
    });
</script>
</body>
</html>




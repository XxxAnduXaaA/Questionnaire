<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Создать форму</title>
  <style>
    .question-block { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    .option-block { margin-left: 20px; }
  </style>
</head>
<body>
<h1>Создать форму</h1>

<form th:action="@{/adminPanel/form/new}" th:object="${form}" method="post">
  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
  <div>
    <label for="title">Название</label>
    <input type="text" id="title" th:field="*{title}" required/>
  </div>

  <div>
    <label for="description">Описание</label>
    <textarea id="description" th:field="*{description}"></textarea>
  </div>

  <h2>Вопросы</h2>
  <div id="questions-container"></div>
  <button type="button" onclick="addQuestion()">Добавить вопрос</button>

  <div>
    <button type="submit">Создать</button>
  </div>
</form>

<a th:href="@{/adminPanel/getAllForms}">К списку форм</a>

<script>
  let questionIndex = 0;

  function addQuestion() {
    const container = document.getElementById("questions-container");
    const idx = questionIndex++;
    const qDiv = document.createElement("div");
    qDiv.className = "question-block";
    qDiv.setAttribute("data-qindex", idx);

    qDiv.innerHTML = `
      <label>Вопрос ${idx + 1}</label>
      <input type="text" name="questions[${idx}].questionText" required/>
      <div class="options-container">
        <div class="option-block">
          <label>Вариант 1</label>
          <input type="text" name="questions[${idx}].answers[0].answerText"/>
        </div>
      </div>
      <button type="button" onclick="addOption(${idx})">Добавить вариант</button>
      <button type="button" onclick="removeQuestion(${idx})">Удалить вопрос</button>
    `;

    const label = document.createElement("label");
    label.textContent = "Вопрос ${idx + 1}";

    const input = document.createElement("input");
    input.type = "text";
    input.name = "questions[${qIndex}].questionText";
    input.required = true

    const button = document.createElement("button");
    button.type = "button";
    button.textContent = "Удалить";
    button.onclick = function() {
      this.parentElement.remove();
      reindexQuestion(qIndex);
    };

    container.appendChild(qDiv);
  }

  function addOption(qIndex) {
    const qDiv = document.querySelector('[data-qindex="' + qIndex + '"]');
    const optionsContainer = qDiv.querySelector(".options-container");
    const optionIndex = optionsContainer.querySelectorAll(".option-block").length;

    const oDiv = document.createElement("div");
    oDiv.className = "option-block";
    oDiv.innerHTML = `
      <label>Вариант ${optionIndex + 1}</label>
      <input type="text" name="questions[${qIndex}].answers[${optionIndex}].answerText"/>
      <button type="button" onclick="this.parentElement.remove(); reindexQuestion(${qIndex});">Удалить</button>
    `;
    optionsContainer.appendChild(oDiv);

    // const label = document.createElement("label");
    // label.textContent = "Вариант ${optionIndex + 1}";
    //
    // const input = document.createElement("input");
    // input.type = "text";
    // input.name = "questions[${qIndex}].answers[${optionIndex}].answerText";
    //
    // const button = document.createElement("button");
    // button.type = "button";
    // button.textContent = "Удалить";
    // button.onclick = function() {
    //   this.parentElement.remove();
    //   reindexQuestion(qIndex);
    // };

  }

  function removeQuestion(index) {
    const qDiv = document.querySelector('[data-qindex="' + index + '"]');
    if (!qDiv) return;
    qDiv.remove();
    reindexAllQuestions();
  }

  function reindexAllQuestions() {
    const container = document.getElementById("questions-container");
    const qBlocks = container.querySelectorAll(".question-block");
    qBlocks.forEach((qEl, newIndex) => {
      qEl.setAttribute("data-qindex", newIndex);
      // label
      const label = qEl.querySelector("label");
      if (label) label.textContent = `Вопрос ${newIndex + 1}`;
      // question input
      const qInput = qEl.querySelector('input[name^="questions"]');
      if (qInput) qInput.setAttribute("name", `questions[${newIndex}].questionText`);
      // reindex options
      reindexQuestion(newIndex);
    });
    // reset global index to next free number
    questionIndex = qBlocks.length;
  }

  function reindexQuestion(qIndex) {
    const qDiv = document.querySelector('[data-qindex="' + qIndex + '"]');
    if (!qDiv) return;
    const options = qDiv.querySelectorAll(".option-block");
    options.forEach((opt, i) => {
      const input = opt.querySelector('input[name*="answers"]');
      if (input) input.setAttribute("name", `questions[${qIndex}].answers[${i}].answerText`);
      const label = opt.querySelector("label");
      if (label) label.textContent = `Вариант ${i + 1}`;
    });
  }
</script>


</script>
</body>
</html>
